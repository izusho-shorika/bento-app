<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>出商 弁当注文システム</title>
  <meta name="robots" content="noindex">
  <style>
    :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--card:#fff;--accent:#2563eb;--danger:#dc2626;--ok:#16a34a}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;line-height:1.7}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:#111;color:#fff;z-index:30}
    header .inner{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
    header .title{font-size:18px;font-weight:700}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:var(--accent);color:#fff;font-weight:700}
    .btn.muted{background:#bbb;color:#222}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.3)}
    .btn.block{display:block;width:100%}
    .btn.small{padding:8px 10px;font-size:14px;border-radius:8px}
    .btn.row{gap:8px}
    .pill{display:inline-block;background:#eee;color:#333;border-radius:999px;padding:2px 8px;font-size:12px}
    .panel{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:16px;margin:12px 0}
    .panel h2{margin:0 0 8px 0;font-size:18px}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .field{display:grid;gap:6px;margin:10px 0}
    .field label{font-weight:700;font-size:14px}
    .field input,.field select,.field textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;background:#fff}
    .hint{color:var(--muted);font-size:13px}
    .center{text-align:center}
    .right{text-align:right}
    footer{position:sticky;bottom:0;background:#fff;border-top:1px solid #eee}
    footer .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;max-width:980px;margin:0 auto}
    .hidden{display:none !important}
    /* cards */
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .card .meta{font-size:13px;color:var(--muted)}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
    .list{display:grid;gap:10px}
    @media (max-width:640px){ .grid.cols-3{grid-template-columns:1fr 1fr}; .grid.cols-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="title">出雲商業 高校生向け 弁当注文</div>
      <button id="logoutBtn" class="btn ghost small hidden">ログアウト</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Login -->
    <section id="loginSec" class="panel">
      <h2>ログイン</h2>
      <div class="field">
        <label for="userId">ユーザーID</label>
        <input id="userId" placeholder="学籍番号など">
      </div>
      <div class="field">
        <label for="password">パスワード</label>
        <input id="password" type="password" placeholder="パスワード">
      </div>
      <div class="row">
        <button id="loginBtn" class="btn">ログイン</button>
        <button id="forgotBtn" class="btn muted">パスワードを忘れた</button>
      </div>
      <p id="loginMsg" class="hint"></p>
    </section>

    <!-- Must change password -->
    <section id="pwChangeSec" class="panel hidden">
      <h2>初回パスワード変更</h2>
      <div class="field">
        <label for="newPw1">新しいパスワード</label>
        <input id="newPw1" type="password" autocomplete="new-password">
      </div>
      <div class="field">
        <label for="newPw2">新しいパスワード（確認）</label>
        <input id="newPw2" type="password" autocomplete="new-password">
      </div>
      <button id="doChangePwBtn" class="btn">変更する</button>
      <p class="hint">安全のため8文字以上を推奨します。</p>
      <p id="pwMsg" class="hint"></p>
    </section>

    <!-- Shop & order -->
    <section id="orderSec" class="panel hidden">
      <h2>注文</h2>
      <div id="orderWindowPill" class="pill">受付中</div>
      <div class="field">
        <label>お店を選択</label>
        <select id="shopSel"></select>
      </div>
      <div id="menuArea" class="grid cols-3"></div>
      <div class="field">
        <label for="note">備考（任意）</label>
        <textarea id="note" rows="2" placeholder="アレルギー等あれば記入してください"></textarea>
      </div>
      <div class="row">
        <div class="right" style="flex:1"><strong>合計</strong> <span id="grandTotal">¥0</span></div>
        <button id="placeOrderBtn" class="btn">この内容で注文</button>
      </div>
      <p id="orderMsg" class="hint"></p>
    </section>

    <!-- History -->
    <section id="historySec" class="panel hidden">
      <h2>注文履歴</h2>
      <div id="historyList" class="list"></div>
      <button id="moreBtn" class="btn block hidden">もっと見る（+10件）</button>
      <p class="hint">直近の注文から順に表示します。最大15件まで。</p>
    </section>
  </main>

  <footer>
    <div class="bar">
      <div class="hint">© Izumo Commercial HS</div>
      <div class="row">
        <button id="toOrderBtn" class="btn small">注文へ</button>
        <button id="toHistoryBtn" class="btn small muted">注文履歴</button>
      </div>
    </div>
  </footer>

  <script>
  // ====== Config ======
  const API_BASE = "https://izusho-bento.toshiyuki-y0506.workers.dev/"; // Workers → GAS exec
  const TEST_MODE = true; // テスト中は常時受付。切替時は false に。

  // ====== State ======
  let TOKEN = null;
  let MUST_CHANGE = false;
  let HISTORY_OFFSET = 0;
  let HISTORY_TOTAL_LOADED = 0;

  // ====== Helpers ======
  const $ = (id)=>document.getElementById(id);
  const fmtJPY = (n)=> new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(n||0);
  const isoLocal = (d)=>{
    const tz = new Intl.DateTimeFormat('ja-JP', { hour12:false, timeZone:'Asia/Tokyo',
      year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).formatToParts(d);
    const get=(t)=>tz.find(x=>x.type===t).value;
    return `${get('year')}/${get('month')}/${get('day')} ${get('hour')}:${get('minute')}`;
  };
  async function callApi(payload){
    const res = await fetch(API_BASE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }
  function show(secId){
    for(const id of ['loginSec','pwChangeSec','orderSec','historySec']) $(id).classList.add('hidden');
    $(secId).classList.remove('hidden');
  }
  function setFooterMode(mode){
    if(mode==='order'){
      $('toOrderBtn').classList.remove('muted'); $('toHistoryBtn').classList.add('muted');
    }else{
      $('toOrderBtn').classList.add('muted'); $('toHistoryBtn').classList.remove('muted');
    }
  }

  // ====== Login flow ======
  $('loginBtn').addEventListener('click', async ()=>{
    $('loginMsg').textContent='処理中...';
    const r = await callApi({action:'login', user_id:$('userId').value.trim(), password:$('password').value});
    if(!r.ok){ $('loginMsg').textContent = r.error||'ログインに失敗しました'; return; }
    TOKEN = r.token; MUST_CHANGE = !!r.must_change;
    $('logoutBtn').classList.remove('hidden');
    if(MUST_CHANGE){ show('pwChangeSec'); } else { await initOrderScreen(); show('orderSec'); setFooterMode('order'); }
    $('loginMsg').textContent='';
  });

  $('logoutBtn').addEventListener('click', ()=>{
    TOKEN = null; MUST_CHANGE=false; HISTORY_OFFSET=0; HISTORY_TOTAL_LOADED=0;
    $('userId').value=''; $('password').value='';
    show('loginSec'); setFooterMode('order'); $('logoutBtn').classList.add('hidden');
  });

  // forgot password (info only – directs to school contact)
  $('forgotBtn').addEventListener('click', ()=>{
    alert('パスワード初期化は先生が行います。担当の先生に「ユーザーID」を伝えて依頼してください。');
  });

  // Must change password
  $('doChangePwBtn').addEventListener('click', async ()=>{
    const a=$('newPw1').value, b=$('newPw2').value;
    if(!a || a.length<6){ $('pwMsg').textContent='6文字以上を推奨します。'; return; }
    if(a!==b){ $('pwMsg').textContent='確認用と一致しません。'; return; }
    const r = await callApi({action:'changePassword', token:TOKEN, new_password:a});
    if(!r.ok){ $('pwMsg').textContent=r.error||'変更に失敗しました'; return; }
    MUST_CHANGE=false; $('pwMsg').textContent='変更しました。';
    await initOrderScreen(); show('orderSec'); setFooterMode('order');
  });

  // ====== Order screen ======
  async function initOrderScreen(){
    // order window pill
    const r = await callApi({action:'getOrderWindow'});
    const open = TEST_MODE ? true : !!r.open;
    $('orderWindowPill').textContent = open ? '受付中' : '受付停止中';
    $('orderWindowPill').className = 'pill ' + (open?'ok':'danger');

    // shops + menu
    const s = await callApi({action:'listShopsAndMenu'});
    const sel = $('shopSel'); sel.innerHTML='';
    (s.shops||[]).forEach(sh=>{
      const opt = document.createElement('option'); opt.value = sh.shop_id; opt.textContent = sh.shop_name;
      sel.appendChild(opt);
    });
    renderMenu(s.menu||[], sel.value);
    sel.onchange = ()=> renderMenu(s.menu||[], sel.value);
    $('note').value='';
    $('grandTotal').textContent = fmtJPY(0);
    $('orderMsg').textContent='';
  }

  function renderMenu(menu, shopId){
    const list = $('menuArea'); list.innerHTML='';
    const items = menu.filter(m=> String(m.shop_id) === String(shopId) && m.enabled!==false );
    items.forEach(item=>{
      const id = `qty-${item.shop_id}-${item.item}`;
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="head">
          <div><strong>${item.item}</strong><div class="meta">¥${item.price}</div></div>
          <div class="row">
            <button class="btn small muted" data-minus="-1">－</button>
            <input id="${id}" type="number" min="0" value="0" style="width:56px;text-align:center;padding:8px;border-radius:10px;border:1px solid #ddd">
            <button class="btn small" data-plus="+1">＋</button>
          </div>
        </div>`;
      card.querySelector('[data-minus]').onclick=()=>updateQty(id,-1,item.price);
      card.querySelector('[data-plus]').onclick=()=>updateQty(id,1,item.price);
      list.appendChild(card);
    });
  }

  function updateQty(inputId, delta, price){
    const el = $(inputId);
    let v = parseInt(el.value||'0',10);
    v = Math.max(0, v + delta);
    el.value = v;
    calcTotal();
  }
  function calcTotal(){
    let sum = 0;
    document.querySelectorAll('#menuArea input[type="number"]').forEach(inp=>{
      const price = Number(inp.closest('.card').querySelector('.meta').textContent.replace('¥',''))||0;
      sum += (Number(inp.value)||0)*price;
    });
    $('grandTotal').textContent = fmtJPY(sum);
  }

  $('placeOrderBtn').addEventListener('click', async ()=>{
    const open = TEST_MODE ? true : (await callApi({action:'getOrderWindow'})).open;
    if(!open){ $('orderMsg').textContent='本日は注文受付を停止しています。'; return; }
    const shop_id = $('shopSel').value;
    const lines = [];
    document.querySelectorAll('#menuArea input[type="number"]').forEach(inp=>{
      const qty = Number(inp.value)||0; if(!qty) return;
      const name = inp.closest('.card').querySelector('strong').textContent;
      const price = Number(inp.closest('.card').querySelector('.meta').textContent.replace('¥',''))||0;
      lines.push({item:name, qty, unit_price:price});
    });
    if(lines.length===0){ $('orderMsg').textContent='数量を入力してください。'; return; }
    const r = await callApi({action:'placeOrder', token:TOKEN, shop_id, note:$('note').value, lines});
    if(!r.ok){ $('orderMsg').textContent = r.error||'注文に失敗しました'; return; }
    $('orderMsg').textContent = '注文を受け付けました。';
    // reset
    document.querySelectorAll('#menuArea input[type="number"]').forEach(inp=> inp.value='0');
    calcTotal();
  });

  // ====== History ======
  async function loadHistory(init=false){
    if(init){ $('historyList').innerHTML=''; HISTORY_OFFSET=0; HISTORY_TOTAL_LOADED=0; }
    const limit = (HISTORY_OFFSET===0) ? 5 : 10; // 1回目=5、2回目=10
    const r = await callApi({action:'listOrders', token:TOKEN, offset:HISTORY_OFFSET, limit});
    if(!r.ok){ alert(r.error||'取得に失敗しました'); return; }
    const list = $('historyList');
    (r.items||[]).forEach(o=>{
      const card = document.createElement('div');
      card.className='card';
      const when = isoLocal(new Date(o.timestamp));
      const itemsHtml = (o.lines||[{item:o.item, qty:o.qty, unit_price:o.unit_price}])
        .map(x=>`<div>・${x.item} × ${x.qty}　<span class="meta">¥${x.unit_price} / 小計 ¥${x.unit_price * x.qty}</span></div>`).join("");
      const noteHtml = o.note ? `<div class="meta">備考：${escapeHtml(o.note)}</div>` : "";
      const subtotal = (o.lines||[{qty:o.qty, unit_price:o.unit_price}]).reduce((s,x)=>s + x.qty * x.unit_price,0);
      card.innerHTML = `
        <div class="head">
          <div><strong>${when}</strong></div>
          <div class="pill">${o.shop_name||('Shop#'+o.shop_id)}</div>
        </div>
        ${itemsHtml}
        ${noteHtml}
        <div class="right"><strong>小計</strong> ${fmtJPY(subtotal)}</div>`;
      list.appendChild(card);
    });
    HISTORY_OFFSET += r.items.length;
    HISTORY_TOTAL_LOADED += r.items.length;
    // 「もっと見る」制御：合計15件まで、かつ今回取得が10件満たない場合は消す
    const showMore = (HISTORY_TOTAL_LOADED < 15) && (r.items.length > 0) && (HISTORY_OFFSET < (r.total||999));
    $('moreBtn').classList.toggle('hidden', !showMore);
  }

  $('toOrderBtn').addEventListener('click', async ()=>{
    await initOrderScreen(); show('orderSec'); setFooterMode('order');
  });
  $('toHistoryBtn').addEventListener('click', async ()=>{
    await loadHistory(true); show('historySec'); setFooterMode('history');
  });
  $('moreBtn').addEventListener('click', async ()=>{
    await loadHistory(false);
  });

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // boot
  show('loginSec'); setFooterMode('order');
  </script>
</body>
</html>
