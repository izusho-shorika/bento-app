<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お弁当注文</title>

  <script>
    const LIFF_ID = "2007592277-egMkGZrD";
    const GAS_URL = "https://izusho-bento.toshiyuki-y0506.workers.dev/";
    const BOT_BASIC_ID = "@029slqnu";
  </script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --brand:#0a7; --accent:#17a2b8; --danger:#dc3545;
      --line:#e5e7eb; --text:#222; --muted:#666; --bg:#f7f7f8;
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Hiragino Kaku Gothic ProN",Meiryo,sans-serif }
    .container{max-width:520px;margin:0 auto;padding:16px 16px 32px}
    h1{font-size:20px;margin:4px 0 12px}
    h2{font-size:18px;margin:16px 0 10px}
    section{display:none} section.active{display:block}
    input,select,button{width:100%;box-sizing:border-box;font-size:16px}
    input,select{padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    button{padding:12px;border:0;border-radius:10px;cursor:pointer}
    .btn{background:var(--brand);color:#fff}
    .btn.secondary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:#333}
    .btn.danger{background:var(--danger);color:#fff}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .note{font-size:12px;color:var(--muted);margin-top:6px}
    .list{display:flex;flex-direction:column;gap:8px}
    .shopBtn{display:block;text-align:left;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
    .itemRow{display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
    .itemRow.selected{outline:2px solid #1976d2}
    .itemRow.soldout{background:#fbe9e7; color:#c62828; opacity:.85; pointer-events:none}
    .row{margin:10px 0}
    /* 修正: ログインフォームの間隔 */
    #loginSec .row { margin-bottom: 12px; }
    #loginSec input { margin-bottom: 8px; }
    
    .header{position:sticky;top:0;background:var(--bg);padding:12px 16px 0}
    .topbar{display:flex;align-items:center;gap:8px;margin:6px 0 12px}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;}
    .modal{width:90%; max-width:420px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal h3{margin:0 0 8px; font-size:18px}
    .modal p{margin:8px 0 16px; line-height:1.6}
    .modal .actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    .help{font-size:12px;color:var(--muted)}
    /* 追加：改行を維持して見やすく表示 */
    .modal pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 16px; line-height:1.6; font-family:inherit}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>お弁当注文ver.2</h1>
    <div class="help">※テスト中のため、時間に関係なく注文できます</div>
  </div>

  <section id="loginSec" class="active">
    <h2>ログイン</h2>
    <div class="row">
      <button id="liffLoginBtn" class="btn secondary" style="display:none">LINEでログイン</button>
    </div>
    <div class="row">
      <input type="text" id="uid" placeholder="学籍番号">
    </div>
    <div class="row">
      <input type="password" id="pw" placeholder="パスワード">
    </div>
    <div class="row">
      <button id="loginBtn" class="btn">ログイン</button>
    </div>
  </section>

  <section id="pwSec">
    <h2>パスワード変更</h2>
    <div class="row">
      <input id="npw" type="password" placeholder="新パスワード（6文字以上）">
    </div>
    <div class="row" style="display:flex; gap:8px">
      <button id="pwBtn" class="btn">変更する</button>
      <button class="btn ghost" id="backToLoginBtn">戻る</button>
    </div>
  </section>

  <section id="shopSec">
    <h2>お店を選択</h2>
    <div id="shops" class="list"></div>
    <div class="row">
      <button class="btn ghost" id="logoutBtn">ログアウト</button>
    </div>
  </section>

  <section id="menuSec">
    <div class="topbar">
      <h2 id="shopTitle" style="margin:0">お弁当を選ぶ</h2>
    </div>

    <div id="menu" class="list"></div>

    <div class="row">
      <label class="help">数量</label>
      <select id="qty">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <div class="row">
      <label class="help">備考（任意）</label>
      <input id="note" placeholder="大盛り など">
    </div>

    <div class="row" style="display:flex; gap:8px; flex-wrap:wrap">
      <button id="orderBtn" class="btn">注文する</button>
      <button class="btn ghost" id="backBtn">← 戻る</button>
    </div>
    <p class="note">売切れの商品は赤色で表示され、選択できません（残数は表示しません）。</p>
  </section>
</div>

<div id="okModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>注文を受け付けました</h3>
    <pre id="okMsg"></pre>
    <div class="actions">
      <button class="btn secondary" id="sendToLineBtn">LINEで受け取る</button>
      <button class="btn" id="okCloseBtn">閉じる</button>
    </div>
  </div>
</div>

<script>
/* ====== ユーティリティ ====== */
let TOKEN=null, initData=null, chosenShop=null, chosenItem=null, lastOrderId=null;
let lastOrderText=null; // ← 4行本文を保持
const $ = id => document.getElementById(id);
const show = id => { document.querySelectorAll('section').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); };
function isOrderOpen(){ return true; } // テスト中は常に受付

// 金額と時刻（JST）
function fmtJPY(n){ return Number(n||0).toLocaleString('ja-JP') + '円'; }
function nowJSTShort(){
  const d = new Date();
  return new Intl.DateTimeFormat('ja-JP', {
    timeZone:'Asia/Tokyo', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', hour12:false
  }).format(d);
}

// 4行の本文を組み立てる（単品）
function buildOrderText(){
  if(!chosenItem) return '';
  const qty   = Number(document.getElementById('qty').value||1);
  const unit  = Number(chosenItem.price||0);
  const sum   = unit * qty;
  return `商品：${chosenItem.item} × ${qty}\n` +
         `単価：${fmtJPY(unit)}\n` +
         `合計：${fmtJPY(sum)}\n` +
         `時刻：${nowJSTShort()}`;
}

// GAS 呼び出し（application/x-www-form-urlencoded）
async function callApi(params){
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded' },
    body: new URLSearchParams(params).toString(),
  });
  if(!res.ok) throw new Error('Load failed');
  const text = await res.text();
  try { return JSON.parse(text); } catch(_){ return { ok:true, raw:text }; }
}

/* ====== 画面描画 ====== */
function renderShops(){
  const wrap = $('shops'); wrap.innerHTML='';
  (initData.shops||[]).forEach(s=>{
    const b = document.createElement('button');
    b.className = 'shopBtn';
    b.textContent = s.shop_name;
    b.onclick = ()=>{ chosenShop=s; renderMenu(s.shop_id); show('menuSec'); };
    wrap.appendChild(b);
  });
}
function renderMenu(shop_id){
  const list = (initData.menu?.[shop_id]) || [];
  $('shopTitle').textContent = 'お弁当を選ぶ（' + ((initData.shops||[]).find(x=>x.shop_id===shop_id)?.shop_name||shop_id) + '）';
  const wrap = $('menu'); wrap.innerHTML=''; chosenItem=null;

  list.forEach(m=>{
    const row = document.createElement('div');
    row.className = 'itemRow';
    row.innerHTML = `<div>${m.item}</div><div>${Number(m.price).toLocaleString('ja-JP')}円</div>`;
    if (m.soldout) row.classList.add('soldout');
    row.onclick = ()=>{
      if(row.classList.contains('soldout')) return;
      document.querySelectorAll('.itemRow').forEach(x=>x.classList.remove('selected'));
      row.classList.add('selected');
      chosenItem = m;
    };
    wrap.appendChild(row);
  });
}

/* ====== 受注完了モーダル ====== */
function openOk(orderId){
  lastOrderId   = orderId;
  lastOrderText = buildOrderText();
  $('okMsg').textContent = lastOrderText;
  $('okModal').style.display='flex';
}
function closeOkAndBack(){
  $('qty').value = 1;
  $('note').value = '';
  chosenItem = null;
  $('okModal').style.display='none';
  show('shopSec');
}

/* ====== LIFF 初期化 ====== */
async function ensureLiff(){
  try{
    await liff.init({ liffId: LIFF_ID });
    $('liffLoginBtn').style.display = liff.isLoggedIn() ? 'none' : 'block';
    $('liffLoginBtn').onclick = ()=> liff.login({ redirectUri: location.href });
  }catch(e){
    console.error('LIFF初期化失敗:', e);
  }
}

/* ====== イベント割り当て ====== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // 戻る/ログアウト/閉じる
  $('backBtn').onclick = ()=>{ chosenItem=null; show('shopSec'); };
  $('backToLoginBtn').onclick = ()=> show('loginSec');
  $('logoutBtn').onclick = ()=>{
    TOKEN=null; chosenShop=null; chosenItem=null;
    $('uid').value=''; $('pw').value=''; show('loginSec');
  };
  $('okCloseBtn').onclick = closeOkAndBack;

  // 「LINEで受け取る」：oaMessage で本文を入力欄に自動挿入（失敗時は静かにコピー）
  $('sendToLineBtn').onclick = async ()=>{
    if(!lastOrderText || !lastOrderText.trim()){
      lastOrderText = buildOrderText();
      if(!lastOrderText) return;
    }
    const botPath = encodeURIComponent(BOT_BASIC_ID); // "@xxxx" → "%40xxxx"
    const oaUrl   = `https://line.me/R/oaMessage/${botPath}/?${encodeURIComponent(lastOrderText)}`;
    try{
      if(window.liff && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')){
        liff.openWindow({ url: oaUrl, external: true });
      }else{
        location.href = oaUrl;
      }
    }catch(_){
      try{ await navigator.clipboard.writeText(lastOrderText); }catch(e){}
    }
  };

  // LIFF
  await ensureLiff();

  // ログイン
  $('loginBtn').onclick = async ()=>{
    const userId = $('uid').value.trim();
    const password = $('pw').value;
    if(!userId || !password){ alert('IDとパスワードを入力してください'); return; }
    const btn = $('loginBtn'); btn.disabled=true;
    try{
      const r = await callApi({ action:'login', uid:userId, pw:password });
      if(!r.ok){ alert(r.msg||'ユーザーIDまたはパスワードが間違っています'); return; }
      TOKEN = r.token;
      if(r.mustChange){ show('pwSec'); } else {
        const init = await callApi({ action:'loadInitData', token:TOKEN });
        
        // 修正: 店舗数表示を削除
        if(!init.ok){ alert('初期データ取得に失敗しました'); return; }
        initData = init; renderShops(); show('shopSec');
      }
    }catch(e){
      console.error(e);
      alert('通信エラー: Load failed');
    }finally{
      btn.disabled=false;
    }
  };

  // パスワード変更
  $('pwBtn').onclick = async ()=>{
    const npw = $('npw').value;
    if(!npw || npw.length<6){ alert('6文字以上にしてください'); return; }
    const btn = $('pwBtn'); btn.disabled=true;
    try{
      const r = await callApi({ action:'changePassword', token:TOKEN, npw });
      if(!r.ok){ alert(r.msg||'変更に失敗'); return; }
      const init = await callApi({ action:'loadInitData', token:TOKEN });
      if(!init.ok){ alert('初期データ取得に失敗しました'); return; }
      initData = init; renderShops(); show('shopSec');
    }catch(e){
      console.error(e);
      alert('通信エラー: Load failed');
    }finally{
      btn.disabled=false;
    }
  };

  // 注文
  $('orderBtn').onclick = async ()=>{
    if(!TOKEN){ alert('セッションが切れました。ログインし直してください。'); show('loginSec'); return; }
    if(!chosenShop || !chosenItem){ alert('商品を選択してください'); return; }
    if(!isOrderOpen()){ alert('現在は受付時間外です'); return; }

    const qty   = Number($('qty').value||1);
    const note = $('note').value||'';
    const btn   = $('orderBtn'); btn.disabled=true;
    try{
      const r = await callApi({
        action:'submitOrder',
        token:TOKEN,
        shop_id: chosenShop.shop_id,
        item: chosenItem.item,
        qty: qty,
        note: note,
        userAgent: navigator.userAgent
      });
      if(!r.ok){
        alert(r.msg || '注文に失敗しました');
        if((r.msg||'').includes('上限に達しました')) renderMenu(chosenShop.shop_id);
        return;
      }
      openOk(r.orderId);
    }catch(e){
      console.error(e);
      alert('通信エラー: Load failed');
    }finally{
      btn.disabled=false;
    }
  };
});
</script>
</body>
</html>
