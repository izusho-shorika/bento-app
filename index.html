<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>お弁当注文</title>
<style>
  :root{
    --brand:#0a7;
    --accent:#17a2b8;
    --danger:#dc3545;
    --line:#e5e7eb;
    --text:#222;
    --muted:#666;
    --bg:#f7f7f8;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  .container{max-width:520px;margin:0 auto;padding:16px 16px 32px}
  h1{font-size:20px;margin:4px 0 12px}
  h2{font-size:18px;margin:16px 0 10px}
  section{display:none}
  section.active{display:block}
  input,select,button{width:100%;box-sizing:border-box;font-size:16px}
  input,select{padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  button{padding:12px;border:0;border-radius:10px;cursor:pointer}
  .btn{background:var(--brand);color:#fff}
  .btn.secondary{background:var(--accent);color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:#333}
  .btn.danger{background:var(--danger);color:#fff}
  .btn[disabled]{opacity:.6;pointer-events:none}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  .list{display:flex;flex-direction:column;gap:8px}
  .shopBtn{display:block;text-align:left;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
  .itemRow{display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .itemRow.selected{outline:2px solid #1976d2}
  .itemRow.soldout{background:#fbe9e7; color:#c62828; opacity:.85; pointer-events:none}
  .row{margin:10px 0}
  .help{font-size:12px;color:var(--muted)}
  .header{position:sticky;top:0;background:var(--bg);padding:12px 16px 0}
  .toolbar{display:flex;gap:8px;margin-top:8px}
  .topbar{display:flex;align-items:center;gap:8px;margin:6px 0 12px}
  .backTop{background:#fff;border:1px solid var(--line);color:#333;padding:8px 12px;border-radius:10px}
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;}
  .modal{width:90%; max-width:420px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal h3{margin:0 0 8px; font-size:18px}
  .modal p{margin:8px 0 16px; line-height:1.6}
  .modal .actions{display:flex; justify-content:flex-end; gap:8px}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>お弁当注文</h1>
    <div class="help">※現在はテスト中のため、時間に関係なく注文できます</div>
  </div>

  <div class="toolbar" style="margin-top:8px">
    <button class="btn secondary" id="relinkBtn">LINE連携（再実行）</button>
    <span class="help" id="linkStatus" style="margin-left:8px;"></span>
  </div>

  <!-- ログイン -->
  <section id="loginSec" class="active">
    <h2>ログイン</h2>
    <div class="row"><input id="uid" placeholder="ユーザーID（例：s23001）"></div>
    <div class="row"><input id="pw" type="password" placeholder="パスワード（6文字以上）"></div>
    <button id="loginBtn" class="btn">ログイン</button>
    <p class="note">初回は仮パスワードでログイン後、変更を求められます。</p>
  </section>

  <!-- パスワード変更 -->
  <section id="pwSec">
    <h2>パスワード変更</h2>
    <div class="row"><input id="npw" type="password" placeholder="新パスワード（6文字以上）"></div>
    <div class="toolbar">
      <button id="pwBtn" class="btn">変更する</button>
      <button class="btn ghost" onclick="show('loginSec')">戻る</button>
    </div>
  </section>

  <!-- お店を選ぶ -->
  <section id="shopSec">
    <h2>お店を選択</h2>
    <div id="shops" class="list"></div>
    <div class="toolbar"><button class="btn ghost" onclick="logout()">ログアウト</button></div>
  </section>

  <!-- 商品を選ぶ -->
  <section id="menuSec">
    <div class="topbar"><h2 id="shopTitle" style="margin:0">お弁当を選ぶ</h2></div>
    <div id="menu" class="list"></div>
    <div class="row"><label class="help">数量</label><input id="qty" type="number" min="1" max="20" value="1"></div>
    <div class="row"><label class="help">備考（任意）</label><input id="note" placeholder="大盛り など"></div>
    <div class="toolbar">
      <button id="orderBtn" class="btn">注文する</button>
      <button class="btn ghost" id="backBtn">← 戻る</button>
    </div>
    <p class="note">売切れの商品は赤色で表示され、選択できません。</p>
  </section>

</div>

<!-- 受注完了ダイアログ -->
<div id="okModal" class="modal-backdrop">
  <div class="modal">
    <h3>注文を受け付けました</h3>
    <p id="okMsg">（注文ID：—）</p>
    <div class="actions"><button class="btn" id="okCloseBtn">閉じる</button></div>
  </div>
</div>

<script>
let TOKEN=null, initData=null, chosenShop=null, chosenItem=null;
function $(id){ return document.getElementById(id); }
function show(id){ document.querySelectorAll('section').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
function isOrderOpen(){ return true; } // テスト中は常に受付可

function loadInit(){
  google.script.run.withSuccessHandler(r=>{
    if(!r.ok){ alert('初期データ取得に失敗しました'); return; }
    initData = r; renderShops(); show('shopSec');
  }).withFailureHandler(()=>alert('通信エラー')).loadInitData();
}

function renderShops(){
  const wrap = $('shops'); wrap.innerHTML='';
  (initData.shops||[]).forEach(s=>{
    const b = document.createElement('button');
    b.className='shopBtn'; b.textContent=s.shop_name;
    b.onclick=()=>{ chosenShop=s; renderMenu(s.shop_id); show('menuSec'); };
    wrap.appendChild(b);
  });
}

function renderMenu(shop_id){
  const list=(initData.menu?.[shop_id])||[];
  $('shopTitle').textContent='お弁当を選ぶ（'+((initData.shops||[]).find(x=>x.shop_id===shop_id)?.shop_name||shop_id)+'）';
  const wrap=$('menu'); wrap.innerHTML=''; chosenItem=null;
  list.forEach(m=>{
    const row=document.createElement('div');
    row.className='itemRow';
    row.innerHTML=`<div>${m.item}</div><div>${Number(m.price).toLocaleString('ja-JP')}円</div>`;
    if(m.soldout) row.classList.add('soldout');
    row.onclick=()=>{ if(row.classList.contains('soldout')) return;
      document.querySelectorAll('.itemRow').forEach(x=>x.classList.remove('selected'));
      row.classList.add('selected'); chosenItem=m; };
    wrap.appendChild(row);
  });
}

function goBackToShop(){ chosenItem=null; show('shopSec'); }
document.addEventListener('DOMContentLoaded',()=>{
  const bb=$('backBtn'); if(bb) bb.onclick=goBackToShop;
});

$('loginBtn').onclick=function(){
  const userId=$('uid').value.trim(), password=$('pw').value;
  if(!userId||!password){ alert('IDとPWを入力'); return; }
  const btn=this; btn.disabled=true;
  google.script.run.withSuccessHandler(r=>{
    btn.disabled=false;
    if(!r.ok){ alert(r.msg||'ログイン失敗'); return; }
    TOKEN=r.token;
    if(r.mustChange) show('pwSec'); else loadInit();
  }).withFailureHandler(()=>{btn.disabled=false;alert('通信エラー');}).login(userId,password);
};

$('pwBtn').onclick=function(){
  const npw=$('npw').value;
  if(!npw||npw.length<6){ alert('6文字以上に'); return; }
  this.disabled=true;
  google.script.run.withSuccessHandler(r=>{
    this.disabled=false;
    if(!r.ok){ alert(r.msg||'変更失敗'); return; }
    loadInit();
  }).withFailureHandler(()=>{this.disabled=false;alert('通信エラー');}).changePassword(TOKEN,npw);
};

$('orderBtn').onclick=function(){
  if(!TOKEN){ alert('ログイン切れ'); show('loginSec'); return; }
  if(!chosenShop||!chosenItem){ alert('商品未選択'); return; }
  if(!isOrderOpen()){ alert('時間外'); return; }
  const qty=$('qty').value, note=$('note').value, btn=this; btn.disabled=true;
  google.script.run.withSuccessHandler(async r=>{
    btn.disabled=false;
    if(!r.ok){ alert(r.msg||'注文失敗'); if((r.msg||'').includes('上限')) renderMenu(chosenShop.shop_id); return; }
    // ✅ 注文確定をトークへ自動送信
    await sendOrderToTalk(chosenShop.shop_name, chosenItem.item, Number(qty), Number(chosenItem.price||0), r.orderId);
    openOk(r.orderId);
  }).withFailureHandler(()=>{btn.disabled=false;alert('通信エラー');}).submitOrder(TOKEN,chosenShop.shop_id,chosenItem.item,qty,note,navigator.userAgent);
};

function logout(){ TOKEN=null; chosenShop=null; chosenItem=null; $('uid').value=''; $('pw').value=''; show('loginSec'); }
function openOk(orderId){ $('okMsg').textContent='注文ID：'+orderId; $('okModal').style.display='flex'; }
function closeOkAndBack(){ $('qty').value=1; $('note').value=''; chosenItem=null; $('okModal').style.display='none'; show('shopSec'); }
$('okCloseBtn').onclick=closeOkAndBack;

// ★LIFF設定
const LIFF_ID='2007592277-egMkGZrD';

// ★トークへ自動送信関数
async function sendOrderToTalk(shopName,itemName,qty,unitPrice,orderId){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isInClient()){ alert('LINEアプリ内で開いてください'); return false; }
    const jpy=n=>Number(n).toLocaleString('ja-JP')+'円';
    const text=
`【注文確定】
店舗：${shopName}
注文ID：${orderId}
商品：${itemName} × ${qty}
単価：${jpy(unitPrice)}
小計：${jpy(unitPrice*qty)}
時刻：${new Date().toLocaleString('ja-JP',{hour12:false})}`;
    await liff.sendMessages([{ type:'text', text }]);
    return true;
  }catch(e){
    alert('トーク送信エラー: '+(e?.message||e)); return false;
  }
}
</script>
</body>
</html>
